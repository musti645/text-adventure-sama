import { Injectable } from '@angular/core';
import * as natural from 'natural';
import { InteractionType } from '../models/interactions/interaction-type.enum';
import { ParseInputResult } from '../models/other/parse-input-result.model';
import * as i0 from "@angular/core";
const language = 'EN';
// see Penn Treebank Part-of-Speech Tags for more info on the tags
const defaultCategory = 'N';
const defaultCategoryCapitalized = 'NNP';
const nounCategories = ['N', 'NN', 'NNS', 'NNP', 'NNPS'];
const verbCategories = ['VB', 'VBD', 'VBG', 'VBN', 'VBO', 'VBZ'];
/**
 * Helps to parse text input and call the corresponding action, returning a response
 */
export class InputParserService {
    constructor() {
    }
    initialize(trainer) {
        return new Promise((resolve) => {
            this.Tokenizer = new natural.WordTokenizer();
            const lexicon = new natural.Lexicon(language, defaultCategory, defaultCategoryCapitalized);
            const ruleSet = new natural.RuleSet('EN');
            this.POSTagger = new natural.BrillPOSTagger(lexicon, ruleSet);
            this.Classifier = new natural.BayesClassifier();
            trainer.trainClassifier(this.Classifier).then(() => resolve(true));
        });
    }
    setGame(game) {
        this.Game = game;
    }
    parseInput(input) {
        const commandsResult = this.getCommandsResponse(input);
        if (commandsResult) {
            return commandsResult;
        }
        // because imperatives are not so common in the brown/penn corpus, we add a 'they ' before
        // the whole sentence, in order to make it a legitimate sentence and identify imperatives as verbs instead of nouns
        input = 'they ' + input;
        const taggedTokens = this.POSTagger.tag(this.Tokenizer.tokenize(input)).taggedWords;
        // we get verbs and nouns, because in many cases a noun may be mistaken to be a verb and vice versa e.g. (a) stick & (to) stick
        const nounsAndVerbs = this.getNounsAndVerbsFromTokenizedInput(taggedTokens);
        const interactionType = this.getInteractionType(input);
        // no interaction type found
        if (interactionType === undefined || interactionType === null) {
            return new ParseInputResult(this.Game.getInvalidInputResponse());
        }
        switch (interactionType) {
            case InteractionType.GO_TO:
                // scenes/gateway actions
                return this.getGoToResponse(nounsAndVerbs);
            case InteractionType.LOOK_AT:
                // item description
                return this.getLookAtResponse(nounsAndVerbs);
            case InteractionType.PICK_UP:
                // add item to inventory
                return this.getPickUpResponse(nounsAndVerbs);
            case InteractionType.USE:
                // use item in inventory or in scene
                return this.getUseResponse(nounsAndVerbs);
            default:
                // do something
                return this.getDoResponse(nounsAndVerbs);
        }
    }
    getCommandsResponse(input) {
        const lowerCaseInput = input.toLocaleLowerCase();
        let commandsResult;
        this.Game.getCommands().some(command => {
            if (command.getTrigger().toLocaleLowerCase() === lowerCaseInput) {
                commandsResult = new ParseInputResult(command.activate(), command.getUseTypeWritingAnimation());
                return true;
            }
        });
        return commandsResult;
    }
    getGoToResponse(relevantWords) {
        const result = new ParseInputResult('');
        // get gateway actions
        const gatewayActions = this.Game.getActionsInScene().filter(val => {
            return val.getInteractionType() === InteractionType.GO_TO;
        });
        if (!gatewayActions || gatewayActions.length <= 0) {
            result.Result = this.Game.getGatewayTargetNotFoundResponse();
            return result;
        }
        const actionDistances = this.getActionDistancesFromNouns(relevantWords, gatewayActions);
        if (!actionDistances || actionDistances.length <= 0) {
            result.Result = this.Game.getGatewayTargetNotFoundResponse();
            return result;
        }
        const action = actionDistances[0].Action;
        result.Result = action.trigger();
        result.IsEndGameResult = action.getIsEndGameAction();
        return result;
    }
    getLookAtResponse(relevantWords) {
        const result = new ParseInputResult('');
        const itemDistances = this.getItemDistancesFromNouns(relevantWords, this.Game.getItemsInScene(), this.Game.getItemsInInventory());
        if (!itemDistances || itemDistances.length <= 0) {
            result.Result = this.Game.getItemNotFoundResponse();
            return result;
        }
        result.Result = itemDistances[0].Item.getDescription();
        return result;
    }
    getPickUpResponse(relevantWords) {
        const result = new ParseInputResult('');
        const itemDistances = this.getItemDistancesFromNouns(relevantWords, this.Game.getItemsInScene(), undefined);
        if (!itemDistances || itemDistances.length <= 0) {
            result.Result = this.Game.getItemNotFoundResponse();
            return result;
        }
        const item = itemDistances[0].Item;
        if (!item.getCanPickUp()) {
            result.Result = item.getCannotPickUpResponse();
            return result;
        }
        // one cannot pick up an item, that has no usages left anymore
        if (item.getUsagesLeft() <= 0) {
            result.Result = item.getNoUsagesLeftResponse();
            return result;
        }
        this.Game.addItemToInventory(item);
        this.Game.removeItemFromScene(item);
        result.Result = this.Game.getItemAddedToInventoryResponse();
        return result;
    }
    getUseResponse(relevantWords) {
        const result = new ParseInputResult('');
        const itemDistances = this.getItemDistancesFromNouns(relevantWords, this.Game.getItemsInScene(), this.Game.getItemsInInventory());
        if (!itemDistances || itemDistances.length <= 0) {
            result.Result = this.Game.getItemNotFoundResponse();
            return result;
        }
        const currentItem = itemDistances[0].Item;
        if (!currentItem.CanUseFunction(currentItem, this.Game.getStage().getCurrentScene(), this.Game.getInventory())) {
            result.Result = currentItem.getCannotUseItemResponse();
            return result;
        }
        result.Result = currentItem.use();
        // if the item was in the inventory and has no usages left anymore -> remove it from inventory
        if (currentItem.WasPickedUp && currentItem.getUsagesLeft() <= 0) {
            result.Result += `\r\n${currentItem.getNoUsagesLeftResponse()}`;
            this.Game.removeItemFromInventory(currentItem);
        }
        return result;
    }
    getDoResponse(relevantWords) {
        const result = new ParseInputResult('');
        const actions = this.Game.getActionsInScene().filter(val => {
            return val.getInteractionType() === InteractionType.DO;
        });
        if (!actions || actions.length <= 0) {
            result.Result = this.Game.getActionNotRecognizedResponse();
            return result;
        }
        const actionDistances = this.getActionDistancesFromNouns(relevantWords, actions);
        if (!actionDistances || actionDistances.length <= 0) {
            result.Result = this.Game.getActionNotRecognizedResponse();
            return result;
        }
        const action = actionDistances[0].Action;
        result.Result = action.trigger();
        result.IsEndGameResult = action.getIsEndGameAction();
        return result;
    }
    getNounsAndVerbsFromTokenizedInput(taggedTokens) {
        return taggedTokens.reduce((result, token) => {
            if (nounCategories.includes(token.tag) || verbCategories.includes(token.tag)) {
                result.push(token.token);
            }
            return result;
        }, []);
    }
    getItemDistancesFromNouns(relevantWords, sceneItems, inventoryItems) {
        const itemDistances = [];
        let items = [];
        if (sceneItems) {
            items = items.concat(sceneItems);
        }
        if (inventoryItems) {
            items = items.concat(inventoryItems);
        }
        items.map(val => {
            const taggedName = this.POSTagger.tag(this.Tokenizer.tokenize(val.Name)).taggedWords;
            taggedName.map(name => {
                relevantWords.map(input => {
                    const distance = natural.DamerauLevenshteinDistance(input, name.token, { transposition_cost: 0 });
                    if (distance <= 1) {
                        itemDistances.push(new ItemDistance(val, distance));
                    }
                });
            });
        });
        return itemDistances.sort(val => val.Distance);
    }
    getActionDistancesFromNouns(relevantWords, actions) {
        const actionDistances = [];
        actions.map(val => {
            const taggedTrigger = this.POSTagger.tag(this.Tokenizer.tokenize(val.getTrigger())).taggedWords;
            taggedTrigger.map(trigger => {
                relevantWords.map(input => {
                    const distance = natural.DamerauLevenshteinDistance(input, trigger.token, { transposition_cost: 0 });
                    if (distance <= 1) {
                        actionDistances.push(new ActionDistance(val, distance));
                    }
                });
            });
        });
        return actionDistances.sort(val => val.Distance);
    }
    getInteractionType(input) {
        const result = this.Classifier.classify(input);
        return this.getInteractionTypeFromClassificationResult(result);
    }
    getInteractionTypeFromClassificationResult(result) {
        switch (result) {
            case 'use':
                return InteractionType.USE;
            case 'look_at':
                return InteractionType.LOOK_AT;
            case 'go_to':
                return InteractionType.GO_TO;
            case 'pick_up':
                return InteractionType.PICK_UP;
            case 'do':
                return InteractionType.DO;
            default:
                return InteractionType.DO;
        }
    }
}
InputParserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function InputParserService_Factory() { return new InputParserService(); }, token: InputParserService, providedIn: "root" });
InputParserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
InputParserService.ctorParameters = () => [];
class ActionTag {
    constructor(action, tag) {
        this.Action = action;
        this.Tag = tag;
    }
}
class ActionDistance {
    constructor(action, distance) {
        this.Action = action;
        this.Distance = distance;
    }
}
class ItemDistance {
    constructor(item, distance) {
        this.Item = item;
        this.Distance = distance;
    }
}
class ItemTag {
    constructor(item, tag) {
        this.Item = item;
        this.Tag = tag;
    }
}
class TaggedToken {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQtcGFyc2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiRTovRG9rdW1lbnRlL1JlcG9zaXRvcmllcy9UZXh0QWR2ZW50dXJlU2FtYS90ZXh0LWFkdmVudHVyZS1zYW1hL3Byb2plY3RzL3RleHQtYWR2ZW50dXJlLXNhbWEvc3JjLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2lucHV0LXBhcnNlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFNM0MsT0FBTyxLQUFLLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDbkMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBRS9FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBDQUEwQyxDQUFDOztBQUM1RSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDdEIsa0VBQWtFO0FBQ2xFLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQztBQUM1QixNQUFNLDBCQUEwQixHQUFHLEtBQUssQ0FBQztBQUN6QyxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN6RCxNQUFNLGNBQWMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFFakU7O0dBRUc7QUFJSCxNQUFNLE9BQU8sa0JBQWtCO0lBTTNCO0lBQ0EsQ0FBQztJQUVNLFVBQVUsQ0FBQyxPQUErQjtRQUM3QyxPQUFPLElBQUksT0FBTyxDQUFVLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUM3QyxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFB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SSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDbkIsQ0FBQztDQUNKO0FBRUQsTUFBTSxjQUFjO0lBSWhCLFlBQW1CLE1BQWMsRUFBRSxRQUFnQjtRQUMvQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0NBQ0o7QUFFRCxNQUFNLFlBQVk7SUFJZCxZQUFtQixJQUFnQixFQUFFLFFBQWdCO1FBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzdCLENBQUM7Q0FDSjtBQUVELE1BQU0sT0FBTztJQUlULFlBQW1CLElBQWdCLEVBQUUsR0FBVztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUNuQixDQUFDO0NBQ0o7QUFFRCxNQUFNLFdBQVc7Q0FJaEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi9tb2RlbHMvYWN0aW9ucy9hY3Rpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbkdhbWVJdGVtIH0gZnJvbSAnLi4vbW9kZWxzL0l0ZW0ubW9kZWwnO1xyXG5pbXBvcnQgeyBHYW1lIH0gZnJvbSAnLi4vbW9kZWxzL2dhbWUubW9kZWwnO1xyXG5cclxuaW1wb3J0ICogYXMgbmF0dXJhbCBmcm9tICduYXR1cmFsJztcclxuaW1wb3J0IHsgSW50ZXJhY3Rpb25UeXBlIH0gZnJvbSAnLi4vbW9kZWxzL2ludGVyYWN0aW9ucy9pbnRlcmFjdGlvbi10eXBlLmVudW0nO1xyXG5pbXBvcnQgeyBJQ2xhc3NpZmljYXRpb25UcmFpbmVyIH0gZnJvbSAnLi9jbGFzc2lmaWNhdGlvbi10cmFpbmVyLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBhcnNlSW5wdXRSZXN1bHQgfSBmcm9tICcuLi9tb2RlbHMvb3RoZXIvcGFyc2UtaW5wdXQtcmVzdWx0Lm1vZGVsJztcclxuY29uc3QgbGFuZ3VhZ2UgPSAnRU4nO1xyXG4vLyBzZWUgUGVubiBUcmVlYmFuayBQYXJ0LW9mLVNwZWVjaCBUYWdzIGZvciBtb3JlIGluZm8gb24gdGhlIHRhZ3NcclxuY29uc3QgZGVmYXVsdENhdGVnb3J5ID0gJ04nO1xyXG5jb25zdCBkZWZhdWx0Q2F0ZWdvcnlDYXBpdGFsaXplZCA9ICdOTlAnO1xyXG5jb25zdCBub3VuQ2F0ZWdvcmllcyA9IFsnTicsICdOTicsICdOTlMnLCAnTk5QJywgJ05OUFMnXTtcclxuY29uc3QgdmVyYkNhdGVnb3JpZXMgPSBbJ1ZCJywgJ1ZCRCcsICdWQkcnLCAnVkJOJywgJ1ZCTycsICdWQlonXTtcclxuXHJcbi8qKlxyXG4gKiBIZWxwcyB0byBwYXJzZSB0ZXh0IGlucHV0IGFuZCBjYWxsIHRoZSBjb3JyZXNwb25kaW5nIGFjdGlvbiwgcmV0dXJuaW5nIGEgcmVzcG9uc2VcclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgSW5wdXRQYXJzZXJTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgR2FtZTogR2FtZTtcclxuICAgIHByaXZhdGUgUE9TVGFnZ2VyOiBuYXR1cmFsLkJyaWxsUE9TVGFnZ2VyO1xyXG4gICAgcHJpdmF0ZSBUb2tlbml6ZXI6IG5hdHVyYWwuV29yZFRva2VuaXplcjtcclxuICAgIHByaXZhdGUgQ2xhc3NpZmllcjogbmF0dXJhbC5CYXllc0NsYXNzaWZpZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXRpYWxpemUodHJhaW5lcjogSUNsYXNzaWZpY2F0aW9uVHJhaW5lcik6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLlRva2VuaXplciA9IG5ldyBuYXR1cmFsLldvcmRUb2tlbml6ZXIoKTtcclxuICAgICAgICAgICAgY29uc3QgbGV4aWNvbiA9IG5ldyBuYXR1cmFsLkxleGljb24obGFuZ3VhZ2UsIGRlZmF1bHRDYXRlZ29yeSwgZGVmYXVsdENhdGVnb3J5Q2FwaXRhbGl6ZWQpO1xyXG4gICAgICAgICAgICBjb25zdCBydWxlU2V0ID0gbmV3IG5hdHVyYWwuUnVsZVNldCgnRU4nKTtcclxuICAgICAgICAgICAgdGhpcy5QT1NUYWdnZXIgPSBuZXcgbmF0dXJhbC5CcmlsbFBPU1RhZ2dlcihsZXhpY29uLCBydWxlU2V0KTtcclxuICAgICAgICAgICAgdGhpcy5DbGFzc2lmaWVyID0gbmV3IG5hdHVyYWwuQmF5ZXNDbGFzc2lmaWVyKCk7XHJcbiAgICAgICAgICAgIHRyYWluZXIudHJhaW5DbGFzc2lmaWVyKHRoaXMuQ2xhc3NpZmllcikudGhlbigoKSA9PiByZXNvbHZlKHRydWUpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgc2V0R2FtZShnYW1lOiBHYW1lKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5HYW1lID0gZ2FtZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcGFyc2VJbnB1dChpbnB1dDogc3RyaW5nKTogUGFyc2VJbnB1dFJlc3VsdCB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZHNSZXN1bHQgPSB0aGlzLmdldENvbW1hbmRzUmVzcG9uc2UoaW5wdXQpO1xyXG4gICAgICAgIGlmIChjb21tYW5kc1Jlc3VsdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gY29tbWFuZHNSZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBiZWNhdXNlIGltcGVyYXRpdmVzIGFyZSBub3Qgc28gY29tbW9uIGluIHRoZSBicm93bi9wZW5uIGNvcnB1cywgd2UgYWRkIGEgJ3RoZXkgJyBiZWZvcmVcclxuICAgICAgICAvLyB0aGUgd2hvbGUgc2VudGVuY2UsIGluIG9yZGVyIHRvIG1ha2UgaXQgYSBsZWdpdGltYXRlIHNlbnRlbmNlIGFuZCBpZGVudGlmeSBpbXBlcmF0aXZlcyBhcyB2ZXJicyBpbnN0ZWFkIG9mIG5vdW5zXHJcbiAgICAgICAgaW5wdXQgPSAndGhleSAnICsgaW5wdXQ7XHJcblxyXG4gICAgICAgIGNvbnN0IHRhZ2dlZFRva2VucyA9IHRoaXMuUE9TVGFnZ2VyLnRhZyh0aGlzLlRva2VuaXplci50b2tlbml6ZShpbnB1dCkpLnRhZ2dlZFdvcmRzO1xyXG4gICAgICAgIC8vIHdlIGdldCB2ZXJicyBhbmQgbm91bnMsIGJlY2F1c2UgaW4gbWFueSBjYXNlcyBhIG5vdW4gbWF5IGJlIG1pc3Rha2VuIHRvIGJlIGEgdmVyYiBhbmQgdmljZSB2ZXJzYSBlLmcuIChhKSBzdGljayAmICh0bykgc3RpY2tcclxuICAgICAgICBjb25zdCBub3Vuc0FuZFZlcmJzID0gdGhpcy5nZXROb3Vuc0FuZFZlcmJzRnJvbVRva2VuaXplZElucHV0KHRhZ2dlZFRva2Vucyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGludGVyYWN0aW9uVHlwZSA9IHRoaXMuZ2V0SW50ZXJhY3Rpb25UeXBlKGlucHV0KTtcclxuXHJcbiAgICAgICAgLy8gbm8gaW50ZXJhY3Rpb24gdHlwZSBmb3VuZFxyXG4gICAgICAgIGlmIChpbnRlcmFjdGlvblR5cGUgPT09IHVuZGVmaW5lZCB8fCBpbnRlcmFjdGlvblR5cGUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZUlucHV0UmVzdWx0KHRoaXMuR2FtZS5nZXRJbnZhbGlkSW5wdXRSZXNwb25zZSgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHN3aXRjaCAoaW50ZXJhY3Rpb25UeXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgSW50ZXJhY3Rpb25UeXBlLkdPX1RPOlxyXG4gICAgICAgICAgICAgICAgLy8gc2NlbmVzL2dhdGV3YXkgYWN0aW9uc1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0R29Ub1Jlc3BvbnNlKG5vdW5zQW5kVmVyYnMpO1xyXG4gICAgICAgICAgICBjYXNlIEludGVyYWN0aW9uVHlwZS5MT09LX0FUOlxyXG4gICAgICAgICAgICAgICAgLy8gaXRlbSBkZXNjcmlwdGlvblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TG9va0F0UmVzcG9uc2Uobm91bnNBbmRWZXJicyk7XHJcbiAgICAgICAgICAgIGNhc2UgSW50ZXJhY3Rpb25UeXBlLlBJQ0tfVVA6XHJcbiAgICAgICAgICAgICAgICAvLyBhZGQgaXRlbSB0byBpbnZlbnRvcnlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFBpY2tVcFJlc3BvbnNlKG5vdW5zQW5kVmVyYnMpO1xyXG4gICAgICAgICAgICBjYXNlIEludGVyYWN0aW9uVHlwZS5VU0U6XHJcbiAgICAgICAgICAgICAgICAvLyB1c2UgaXRlbSBpbiBpbnZlbnRvcnkgb3IgaW4gc2NlbmVcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVzZVJlc3BvbnNlKG5vdW5zQW5kVmVyYnMpO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgLy8gZG8gc29tZXRoaW5nXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREb1Jlc3BvbnNlKG5vdW5zQW5kVmVyYnMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldENvbW1hbmRzUmVzcG9uc2UoaW5wdXQ6IHN0cmluZyk6IFBhcnNlSW5wdXRSZXN1bHQge1xyXG4gICAgICAgIGNvbnN0IGxvd2VyQ2FzZUlucHV0ID0gaW5wdXQudG9Mb2NhbGVMb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgbGV0IGNvbW1hbmRzUmVzdWx0OiBQYXJzZUlucHV0UmVzdWx0O1xyXG4gICAgICAgIHRoaXMuR2FtZS5nZXRDb21tYW5kcygpLnNvbWUoY29tbWFuZCA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjb21tYW5kLmdldFRyaWdnZXIoKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSBsb3dlckNhc2VJbnB1dCkge1xyXG4gICAgICAgICAgICAgICAgY29tbWFuZHNSZXN1bHQgPSBuZXcgUGFyc2VJbnB1dFJlc3VsdChjb21tYW5kLmFjdGl2YXRlKCksIGNvbW1hbmQuZ2V0VXNlVHlwZVdyaXRpbmdBbmltYXRpb24oKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gY29tbWFuZHNSZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldEdvVG9SZXNwb25zZShyZWxldmFudFdvcmRzOiBzdHJpbmdbXSk6IFBhcnNlSW5wdXRSZXN1bHQge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBQYXJzZUlucHV0UmVzdWx0KCcnKTtcclxuICAgICAgICAvLyBnZXQgZ2F0ZXdheSBhY3Rpb25zXHJcbiAgICAgICAgY29uc3QgZ2F0ZXdheUFjdGlvbnMgPSB0aGlzLkdhbWUuZ2V0QWN0aW9uc0luU2NlbmUoKS5maWx0ZXIodmFsID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbC5nZXRJbnRlcmFjdGlvblR5cGUoKSA9PT0gSW50ZXJhY3Rpb25UeXBlLkdPX1RPO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAoIWdhdGV3YXlBY3Rpb25zIHx8IGdhdGV3YXlBY3Rpb25zLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0R2F0ZXdheVRhcmdldE5vdEZvdW5kUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFjdGlvbkRpc3RhbmNlcyA9IHRoaXMuZ2V0QWN0aW9uRGlzdGFuY2VzRnJvbU5vdW5zKHJlbGV2YW50V29yZHMsIGdhdGV3YXlBY3Rpb25zKTtcclxuXHJcbiAgICAgICAgaWYgKCFhY3Rpb25EaXN0YW5jZXMgfHwgYWN0aW9uRGlzdGFuY2VzLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0R2F0ZXdheVRhcmdldE5vdEZvdW5kUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFjdGlvbiA9IGFjdGlvbkRpc3RhbmNlc1swXS5BY3Rpb247XHJcblxyXG4gICAgICAgIHJlc3VsdC5SZXN1bHQgPSBhY3Rpb24udHJpZ2dlcigpO1xyXG4gICAgICAgIHJlc3VsdC5Jc0VuZEdhbWVSZXN1bHQgPSBhY3Rpb24uZ2V0SXNFbmRHYW1lQWN0aW9uKCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldExvb2tBdFJlc3BvbnNlKHJlbGV2YW50V29yZHM6IHN0cmluZ1tdKTogUGFyc2VJbnB1dFJlc3VsdCB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFBhcnNlSW5wdXRSZXN1bHQoJycpO1xyXG5cclxuICAgICAgICBjb25zdCBpdGVtRGlzdGFuY2VzID0gdGhpcy5nZXRJdGVtRGlzdGFuY2VzRnJvbU5vdW5zKHJlbGV2YW50V29yZHMsXHJcbiAgICAgICAgICAgIHRoaXMuR2FtZS5nZXRJdGVtc0luU2NlbmUoKSxcclxuICAgICAgICAgICAgdGhpcy5HYW1lLmdldEl0ZW1zSW5JbnZlbnRvcnkoKSk7XHJcblxyXG4gICAgICAgIGlmICghaXRlbURpc3RhbmNlcyB8fCBpdGVtRGlzdGFuY2VzLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0SXRlbU5vdEZvdW5kUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlc3VsdC5SZXN1bHQgPSBpdGVtRGlzdGFuY2VzWzBdLkl0ZW0uZ2V0RGVzY3JpcHRpb24oKTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRQaWNrVXBSZXNwb25zZShyZWxldmFudFdvcmRzOiBzdHJpbmdbXSk6IFBhcnNlSW5wdXRSZXN1bHQge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBQYXJzZUlucHV0UmVzdWx0KCcnKTtcclxuXHJcbiAgICAgICAgY29uc3QgaXRlbURpc3RhbmNlcyA9IHRoaXMuZ2V0SXRlbURpc3RhbmNlc0Zyb21Ob3VucyhyZWxldmFudFdvcmRzLFxyXG4gICAgICAgICAgICB0aGlzLkdhbWUuZ2V0SXRlbXNJblNjZW5lKCksXHJcbiAgICAgICAgICAgIHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICAgIGlmICghaXRlbURpc3RhbmNlcyB8fCBpdGVtRGlzdGFuY2VzLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0SXRlbU5vdEZvdW5kUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW0gPSBpdGVtRGlzdGFuY2VzWzBdLkl0ZW07XHJcblxyXG4gICAgICAgIGlmICghaXRlbS5nZXRDYW5QaWNrVXAoKSkge1xyXG4gICAgICAgICAgICByZXN1bHQuUmVzdWx0ID0gaXRlbS5nZXRDYW5ub3RQaWNrVXBSZXNwb25zZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gb25lIGNhbm5vdCBwaWNrIHVwIGFuIGl0ZW0sIHRoYXQgaGFzIG5vIHVzYWdlcyBsZWZ0IGFueW1vcmVcclxuICAgICAgICBpZiAoaXRlbS5nZXRVc2FnZXNMZWZ0KCkgPD0gMCkge1xyXG4gICAgICAgICAgICByZXN1bHQuUmVzdWx0ID0gaXRlbS5nZXROb1VzYWdlc0xlZnRSZXNwb25zZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5HYW1lLmFkZEl0ZW1Ub0ludmVudG9yeShpdGVtKTtcclxuXHJcbiAgICAgICAgdGhpcy5HYW1lLnJlbW92ZUl0ZW1Gcm9tU2NlbmUoaXRlbSk7XHJcblxyXG4gICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0SXRlbUFkZGVkVG9JbnZlbnRvcnlSZXNwb25zZSgpO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldFVzZVJlc3BvbnNlKHJlbGV2YW50V29yZHM6IHN0cmluZ1tdKTogUGFyc2VJbnB1dFJlc3VsdCB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFBhcnNlSW5wdXRSZXN1bHQoJycpO1xyXG5cclxuICAgICAgICBjb25zdCBpdGVtRGlzdGFuY2VzID0gdGhpcy5nZXRJdGVtRGlzdGFuY2VzRnJvbU5vdW5zKHJlbGV2YW50V29yZHMsXHJcbiAgICAgICAgICAgIHRoaXMuR2FtZS5nZXRJdGVtc0luU2NlbmUoKSxcclxuICAgICAgICAgICAgdGhpcy5HYW1lLmdldEl0ZW1zSW5JbnZlbnRvcnkoKSk7XHJcblxyXG4gICAgICAgIGlmICghaXRlbURpc3RhbmNlcyB8fCBpdGVtRGlzdGFuY2VzLmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5SZXN1bHQgPSB0aGlzLkdhbWUuZ2V0SXRlbU5vdEZvdW5kUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRJdGVtID0gaXRlbURpc3RhbmNlc1swXS5JdGVtO1xyXG5cclxuICAgICAgICBpZiAoIWN1cnJlbnRJdGVtLkNhblVzZUZ1bmN0aW9uKGN1cnJlbnRJdGVtLCB0aGlzLkdhbWUuZ2V0U3RhZ2UoKS5nZXRDdXJyZW50U2NlbmUoKSwgdGhpcy5HYW1lLmdldEludmVudG9yeSgpKSkge1xyXG4gICAgICAgICAgICByZXN1bHQuUmVzdWx0ID0gY3VycmVudEl0ZW0uZ2V0Q2Fubm90VXNlSXRlbVJlc3BvbnNlKCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXN1bHQuUmVzdWx0ID0gY3VycmVudEl0ZW0udXNlKCk7XHJcblxyXG4gICAgICAgIC8vIGlmIHRoZSBpdGVtIHdhcyBpbiB0aGUgaW52ZW50b3J5IGFuZCBoYXMgbm8gdXNhZ2VzIGxlZnQgYW55bW9yZSAtPiByZW1vdmUgaXQgZnJvbSBpbnZlbnRvcnlcclxuICAgICAgICBpZiAoY3VycmVudEl0ZW0uV2FzUGlja2VkVXAgJiYgY3VycmVudEl0ZW0uZ2V0VXNhZ2VzTGVmdCgpIDw9IDApIHtcclxuICAgICAgICAgICAgcmVzdWx0LlJlc3VsdCArPSBgXFxyXFxuJHtjdXJyZW50SXRlbS5nZXROb1VzYWdlc0xlZnRSZXNwb25zZSgpfWA7XHJcbiAgICAgICAgICAgIHRoaXMuR2FtZS5yZW1vdmVJdGVtRnJvbUludmVudG9yeShjdXJyZW50SXRlbSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXREb1Jlc3BvbnNlKHJlbGV2YW50V29yZHM6IHN0cmluZ1tdKTogUGFyc2VJbnB1dFJlc3VsdCB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFBhcnNlSW5wdXRSZXN1bHQoJycpO1xyXG5cclxuICAgICAgICBjb25zdCBhY3Rpb25zID0gdGhpcy5HYW1lLmdldEFjdGlvbnNJblNjZW5lKCkuZmlsdGVyKHZhbCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWwuZ2V0SW50ZXJhY3Rpb25UeXBlKCkgPT09IEludGVyYWN0aW9uVHlwZS5ETztcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKCFhY3Rpb25zIHx8IGFjdGlvbnMubGVuZ3RoIDw9IDApIHtcclxuICAgICAgICAgICAgcmVzdWx0LlJlc3VsdCA9IHRoaXMuR2FtZS5nZXRBY3Rpb25Ob3RSZWNvZ25pemVkUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFjdGlvbkRpc3RhbmNlcyA9IHRoaXMuZ2V0QWN0aW9uRGlzdGFuY2VzRnJvbU5vdW5zKHJlbGV2YW50V29yZHMsIGFjdGlvbnMpO1xyXG5cclxuICAgICAgICBpZiAoIWFjdGlvbkRpc3RhbmNlcyB8fCBhY3Rpb25EaXN0YW5jZXMubGVuZ3RoIDw9IDApIHtcclxuICAgICAgICAgICAgcmVzdWx0LlJlc3VsdCA9IHRoaXMuR2FtZS5nZXRBY3Rpb25Ob3RSZWNvZ25pemVkUmVzcG9uc2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFjdGlvbiA9IGFjdGlvbkRpc3RhbmNlc1swXS5BY3Rpb247XHJcblxyXG4gICAgICAgIHJlc3VsdC5SZXN1bHQgPSBhY3Rpb24udHJpZ2dlcigpO1xyXG4gICAgICAgIHJlc3VsdC5Jc0VuZEdhbWVSZXN1bHQgPSBhY3Rpb24uZ2V0SXNFbmRHYW1lQWN0aW9uKCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0Tm91bnNBbmRWZXJic0Zyb21Ub2tlbml6ZWRJbnB1dCh0YWdnZWRUb2tlbnM6IFRhZ2dlZFRva2VuW10pOiBhbnkge1xyXG4gICAgICAgIHJldHVybiB0YWdnZWRUb2tlbnMucmVkdWNlPHN0cmluZ1tdPigocmVzdWx0LCB0b2tlbikgPT4ge1xyXG4gICAgICAgICAgICBpZiAobm91bkNhdGVnb3JpZXMuaW5jbHVkZXModG9rZW4udGFnKSB8fCB2ZXJiQ2F0ZWdvcmllcy5pbmNsdWRlcyh0b2tlbi50YWcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0b2tlbi50b2tlbik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfSwgW10pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SXRlbURpc3RhbmNlc0Zyb21Ob3VucyhyZWxldmFudFdvcmRzOiBzdHJpbmdbXSwgc2NlbmVJdGVtczogSW5HYW1lSXRlbVtdLCBpbnZlbnRvcnlJdGVtczogSW5HYW1lSXRlbVtdKTogSXRlbURpc3RhbmNlW10ge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1EaXN0YW5jZXM6IEl0ZW1EaXN0YW5jZVtdID0gW107XHJcblxyXG4gICAgICAgIGxldCBpdGVtcyA9IFtdO1xyXG4gICAgICAgIGlmIChzY2VuZUl0ZW1zKSB7XHJcbiAgICAgICAgICAgIGl0ZW1zID0gaXRlbXMuY29uY2F0KHNjZW5lSXRlbXMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGludmVudG9yeUl0ZW1zKSB7XHJcbiAgICAgICAgICAgIGl0ZW1zID0gaXRlbXMuY29uY2F0KGludmVudG9yeUl0ZW1zKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGl0ZW1zLm1hcCh2YWwgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YWdnZWROYW1lID0gdGhpcy5QT1NUYWdnZXIudGFnKHRoaXMuVG9rZW5pemVyLnRva2VuaXplKHZhbC5OYW1lKSkudGFnZ2VkV29yZHM7XHJcbiAgICAgICAgICAgIHRhZ2dlZE5hbWUubWFwKG5hbWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVsZXZhbnRXb3Jkcy5tYXAoaW5wdXQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gbmF0dXJhbC5EYW1lcmF1TGV2ZW5zaHRlaW5EaXN0YW5jZShpbnB1dCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZS50b2tlbiwgeyB0cmFuc3Bvc2l0aW9uX2Nvc3Q6IDAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlIDw9IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbURpc3RhbmNlcy5wdXNoKG5ldyBJdGVtRGlzdGFuY2UodmFsLCBkaXN0YW5jZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBpdGVtRGlzdGFuY2VzLnNvcnQodmFsID0+IHZhbC5EaXN0YW5jZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRBY3Rpb25EaXN0YW5jZXNGcm9tTm91bnMocmVsZXZhbnRXb3Jkczogc3RyaW5nW10sIGFjdGlvbnM6IEFjdGlvbltdKTogQWN0aW9uRGlzdGFuY2VbXSB7XHJcbiAgICAgICAgY29uc3QgYWN0aW9uRGlzdGFuY2VzOiBBY3Rpb25EaXN0YW5jZVtdID0gW107XHJcblxyXG4gICAgICAgIGFjdGlvbnMubWFwKHZhbCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhZ2dlZFRyaWdnZXIgPSB0aGlzLlBPU1RhZ2dlci50YWcodGhpcy5Ub2tlbml6ZXIudG9rZW5pemUodmFsLmdldFRyaWdnZXIoKSkpLnRhZ2dlZFdvcmRzO1xyXG5cclxuICAgICAgICAgICAgdGFnZ2VkVHJpZ2dlci5tYXAodHJpZ2dlciA9PiB7XHJcbiAgICAgICAgICAgICAgICByZWxldmFudFdvcmRzLm1hcChpbnB1dCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBuYXR1cmFsLkRhbWVyYXVMZXZlbnNodGVpbkRpc3RhbmNlKGlucHV0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyLnRva2VuLCB7IHRyYW5zcG9zaXRpb25fY29zdDogMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPD0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25EaXN0YW5jZXMucHVzaChuZXcgQWN0aW9uRGlzdGFuY2UodmFsLCBkaXN0YW5jZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGFjdGlvbkRpc3RhbmNlcy5zb3J0KHZhbCA9PiB2YWwuRGlzdGFuY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRJbnRlcmFjdGlvblR5cGUoaW5wdXQ6IHN0cmluZyk6IEludGVyYWN0aW9uVHlwZSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5DbGFzc2lmaWVyLmNsYXNzaWZ5KGlucHV0KTtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnRlcmFjdGlvblR5cGVGcm9tQ2xhc3NpZmljYXRpb25SZXN1bHQocmVzdWx0KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0SW50ZXJhY3Rpb25UeXBlRnJvbUNsYXNzaWZpY2F0aW9uUmVzdWx0KHJlc3VsdDogc3RyaW5nKTogSW50ZXJhY3Rpb25UeXBlIHtcclxuICAgICAgICBzd2l0Y2ggKHJlc3VsdCkge1xyXG4gICAgICAgICAgICBjYXNlICd1c2UnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEludGVyYWN0aW9uVHlwZS5VU0U7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xvb2tfYXQnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEludGVyYWN0aW9uVHlwZS5MT09LX0FUO1xyXG4gICAgICAgICAgICBjYXNlICdnb190byc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gSW50ZXJhY3Rpb25UeXBlLkdPX1RPO1xyXG4gICAgICAgICAgICBjYXNlICdwaWNrX3VwJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiBJbnRlcmFjdGlvblR5cGUuUElDS19VUDtcclxuICAgICAgICAgICAgY2FzZSAnZG8nOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEludGVyYWN0aW9uVHlwZS5ETztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiBJbnRlcmFjdGlvblR5cGUuRE87XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5cclxuY2xhc3MgQWN0aW9uVGFnIHtcclxuICAgIHB1YmxpYyBBY3Rpb246IEFjdGlvbjtcclxuICAgIHB1YmxpYyBUYWc6IHN0cmluZztcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoYWN0aW9uOiBBY3Rpb24sIHRhZzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5BY3Rpb24gPSBhY3Rpb247XHJcbiAgICAgICAgdGhpcy5UYWcgPSB0YWc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIEFjdGlvbkRpc3RhbmNlIHtcclxuICAgIHB1YmxpYyBBY3Rpb246IEFjdGlvbjtcclxuICAgIHB1YmxpYyBEaXN0YW5jZTogbnVtYmVyO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihhY3Rpb246IEFjdGlvbiwgZGlzdGFuY2U6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuQWN0aW9uID0gYWN0aW9uO1xyXG4gICAgICAgIHRoaXMuRGlzdGFuY2UgPSBkaXN0YW5jZTtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgSXRlbURpc3RhbmNlIHtcclxuICAgIHB1YmxpYyBJdGVtOiBJbkdhbWVJdGVtO1xyXG4gICAgcHVibGljIERpc3RhbmNlOiBudW1iZXI7XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKGl0ZW06IEluR2FtZUl0ZW0sIGRpc3RhbmNlOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLkl0ZW0gPSBpdGVtO1xyXG4gICAgICAgIHRoaXMuRGlzdGFuY2UgPSBkaXN0YW5jZTtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgSXRlbVRhZyB7XHJcbiAgICBwdWJsaWMgSXRlbTogSW5HYW1lSXRlbTtcclxuICAgIHB1YmxpYyBUYWc6IHN0cmluZztcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoaXRlbTogSW5HYW1lSXRlbSwgdGFnOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLkl0ZW0gPSBpdGVtO1xyXG4gICAgICAgIHRoaXMuVGFnID0gdGFnO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBUYWdnZWRUb2tlbiB7XHJcbiAgICB0b2tlbjogc3RyaW5nO1xyXG4gICAgdGFnOiBzdHJpbmc7XHJcbiAgICBkaXN0YW5jZTogbnVtYmVyO1xyXG59XHJcbiJdfQ==